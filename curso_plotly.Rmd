---
title: "Gráficas interactivas con plotly"
author: "ixpantia"
date: "11 de enero, 2020"
always_allow_html: yes
output:
  html_document:
    code_folding: hide
    self_contained: true
    number_sections: no
    theme: spacelab
    toc: yes
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
options(scipen = 100, digits = 2)

library(dplyr)
library(ggplot2)
library(lubridate)
library(plotly)
```

# Introducción

Este documento contiene el código que se usará para la primera partes del **Curso Profesional: Visualización de datos con R**. En particular, el documento primero introduce la gramática de gráficos usada por el paquete `ggplot` y luego elabora en personalizaciones avanzadas de gráficos. El curso se imparte como parte de las iniciativas de [Data Latam](https://datalata.com). Data Latam es una comunidad Latinoamericana de profesionales y académicos aplicando ciencia de datos en su día a día en la industria de datos en Latino América. En sus eventos, cursos y programas de extensión exploramos tecnologías, aprendemos sobre ciencia de datos, hablamos de tendencias y eventos relevantes de la industria, y compartimos novedades del sector.

## Datos para el curso

Para el curso se hará uso de datos de delitos del Poder Judicial de Costa Rica así como proyecciones de población disponibles del Instituto Nacional de Estadística (INEC) de Costa Rica. La limpieza y procesamiento que se le dieron a los datos orignales para prepararlos para este curso se describe en el documentno de [Preparación de datos](https://github.com/datalatam/visualizacion/blob/master/preparadatos.Rmd).

Dicho documento genera el archivo de Excel `datos_cr.xlsx`, el cual se carga a continuación.

```{r ingerir_datos, include = FALSE}
datos_cr <- readxl::read_excel("datos/datos_cr.xlsx") %>% 
  mutate(fecha = as.Date(fecha))
```

## Iniciando con plotly:

```{r}
delitos_pob_ubic <- datos_cr %>% 
  group_by(provincia, ubicacion, pob2016) %>% 
  tally(name = "cantidad")

plot_ly(delitos_pob_ubic, x = ~pob2016, y = ~cantidad)
```

## Gráfico de cajas (boxplot)
```{r}

```

## Gráfico de barras

A continuación, el proceso de construcción de un gráfico desde la prueba de
concepto hasta pulirlo para que sea de comunicación:

```{r}
# Primer paso
ggplot(datos_cr, aes(x = fecha, fill =  delito)) + 
  geom_bar()

# Segundo paso
ggplot(datos_cr, aes(x = fecha, fill =  delito)) + 
  scale_x_date(date_labels = "%b-%Y", date_breaks = "1 month") +
  geom_bar() 

# Tercer paso
datos_cr %>% 
  mutate(mes = month(fecha, label = TRUE)) %>% 
  ggplot(aes(mes, fill = delito)) +
  geom_bar() + 
  theme_bw(base_size = 16)

# Cuarto paso:
datos_cr %>% 
  mutate(mes = month(fecha, label = TRUE)) %>% 
  ggplot(aes(mes, fill = delito)) +
  geom_bar() + 
  scale_fill_viridis_d() + 
  theme_minimal(base_size = 16)

# Quinto paso:
datos_cr %>% 
  mutate(mes = month(fecha, label = TRUE)) %>% 
  ggplot(aes(mes, fill = delito)) +
  geom_bar() + 
  scale_fill_viridis_d() + 
  xlab("Mes del año 2019") + ylab("Total de casos") +
  theme_minimal(base_size = 16)

# Sexto paso
datos_cr %>% 
  mutate(mes = month(fecha, label = TRUE)) %>% 
  ggplot(aes(mes, fill = delito)) +
  geom_bar() + 
  scale_fill_viridis_d() + 
  xlab("Mes del año 2019") + ylab("Total de casos") +
  labs(title = "Total de tipos de delitos en Costa Rica durante el 2019",
       subtitle = "Datos obtenidos del Poder Judicial",
       fill = "Tipo de delito") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom")

## Septimo paso
plot_1 <- datos_cr %>% 
  mutate(mes = month(fecha, label = TRUE)) %>% 
  ggplot(aes(mes, fill = delito)) +
  geom_bar() + 
  scale_fill_viridis_d() + 
  xlab("Mes del año 2019") + ylab("Total de casos") +
  labs(title = "Total de tipos de delitos en Costa Rica durante el 2019",
       subtitle = "Datos obtenidos del Poder Judicial",
       fill = "Tipo de delito") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom")

ggplotly(plot_1)

# Octavo paso:
ggplotly(plot_1) %>% 
  config(displayModeBar = F)
```

El  mismo gráfico pero construido con ggplotly directamente:

```{r}
# Paso 1
delitos_conteo <- datos_cr %>% 
  mutate(mes = month(fecha, label = TRUE)) %>% 
  count(mes, delito)

# Paso 2
plot_ly(data = delitos_conteo,
        x  = ~mes,
        y = ~n,
        type = "bar",
        color = ~delito)

# Paso 3
plot_ly(data = delitos_conteo,
        x  = ~mes,
        y = ~n,
        type = "bar",
        color = ~delito) %>% 
  layout(yaxis = list(title = 'Count'), barmode = 'stack')
```






